<!-- app/templates/goal_card.html -->
<div class="col-md-6 mb-4">
    <div class="card border-dark shadow-sm h-100" data-goal-id="{{ goal.id }}">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <span class="goal-title">{{ goal.title }}</span>
                <small class="badge bg-dark ms-2">{{ goal.type }}</small>
            </h5>
            <div>
                <button class="btn btn-sm btn-outline-dark edit-goal">Edit</button>
                <button class="btn btn-sm btn-outline-danger delete-goal">Delete</button>
            </div>
        </div>
        <div class="card-body">
            <p><strong>Description:</strong> {{ goal.description }}</p>
            {% if goal.motivation %}
                <p><strong>Motivation:</strong> <em>{{ goal.motivation }}</em></p>
            {% endif %}

            <!-- Overall Progress -->
            <div class="progress mb-3" style="height: 25px;">
                <div class="progress-bar bg-dark text-white fw-bold" style="width: {{ goal.progress() }}%">
                    {{ goal.progress() }}%
                </div>
            </div>

            <!-- STEP CARDS BY QUARTER -->
            <div class="steps-container">
                {% if goal.steps %}
                    {% for quarter_date, steps in goal.nested_steps().items() %}
                        <div class="mb-4 p-3 border-start border-3 border-dark">
                            <h6 class="fw-bold mb-3">
                                Q{{ ((quarter_date.month-1)//3)+1 }}: {{ quarter_date.strftime('%B %Y') }}
                            </h6>
                            <div class="row g-3">
                                <!-- ORDER: quarter → month → week → day -->
                                {% set type_order = ['quarter', 'month', 'week', 'day'] %}
                                {% for step_type in type_order %}
                                    {% for month_date, weeks in steps.items() %}
                                        {% for week_date, day_steps in weeks.items() %}
                                            {% for step in day_steps %}
                                                {% if step.step_type == step_type %}
                                                    <div class="col-12">
                                                        <div class="card border-dark step-card h-100" data-step-id="{{ step.id }}">
                                                            <div class="card-body p-3 d-flex justify-content-between align-items-start">
                                                                <div class="form-check flex-grow-1">
                                                                    <input class="form-check-input step-checkbox" type="checkbox" {% if step.completed %}checked{% endif %}>
                                                                    <label class="form-check-label {% if step.completed %}text-decoration-line-through text-muted{% endif %}">
                                                                        <strong>{{ step.step_type|upper }}:</strong> {{ step.title }}
                                                                        {% if step.due_date %}
                                                                            <small class="text-muted d-block">
                                                                                {{ step.due_date.strftime('%b %d') }}{% if step.step_type == 'week' %} (Mon){% endif %}
                                                                            </small>
                                                                        {% endif %}
                                                                    </label>
                                                                </div>
                                                                <div class="ms-3">
                                                                    <button class="btn btn-sm btn-outline-dark edit-step">Edit</button>
                                                                    <button class="btn btn-sm btn-outline-danger delete-step">Delete</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    {% endfor %}
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted">No steps in this quarter.</p>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Add steps to see them grouped by quarter!</p>
                {% endif %}
            </div>

            <!-- Add Step -->
            <div class="input-group mt-4">
                <input type="text" class="form-control form-control-sm new-step" placeholder="New step...">
                <input type="date" class="form-control form-control-sm date-input" style="width: 130px;">
                <select class="form-select form-select-sm type-select" style="width: 110px;">
                    <option value="auto">Auto</option>
                    <option value="quarter">Quarter</option>
                    <option value="month">Month</option>
                    <option value="week">Week</option>
                    <option value="day">Day</option>
                </select>
                <button class="btn btn-sm btn-dark add-step">Add</button>
            </div>
        </div>
    </div>
</div>