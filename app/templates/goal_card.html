<!-- app/templates/goal_card.html -->
{% macro render_goal(goal, depth=0) %}
    <div class="goal-node mb-3" style="margin-left: {{ depth * 25 }}px;">
        <div class="card border-dark shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                <div class="d-flex align-items-center flex-grow-1">
                    <input type="checkbox"
                           class="form-check-input complete-goal me-2"
                           data-goal-id="{{ goal.id }}"
                           {% if goal.progress() == 100 %}checked{% endif %}>
                    <h6 class="mb-0 fw-bold">
                        <span class="text-uppercase text-primary">{{ goal.level() }}</span>:
                        <span class="goal-title">{{ goal.title }}</span>
                        {% if goal.due_date %}
                            <small class="text-muted ms-2">
                                Due: {{ goal.due_date.strftime('%b %d, %Y') }}
                            </small>
                        {% endif %}
                    </h6>
                </div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-success add-subgoal"
                            data-parent-id="{{ goal.id }}"
                            title="Add Sub-Goal">
                        +
                    </button>
                    <button class="btn btn-outline-dark edit-goal"
                            data-goal-id="{{ goal.id }}"
                            title="Edit">
                        Edit
                    </button>
                    <button class="btn btn-outline-danger delete-goal"
                            data-goal-id="{{ goal.id }}"
                            title="Delete">
                        Delete
                    </button>
                </div>
            </div>
            <div class="card-body py-2 px-3">
                {% if goal.description %}
                    <p class="small text-muted mb-1">{{ goal.description }}</p>
                {% endif %}
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-dark"
                         style="width: {{ goal.progress() }}%"
                         role="progressbar">
                    </div>
                </div>
                <small class="text-muted float-end">{{ goal.progress() }}%</small>
            </div>
        </div>

        <!-- RECURSIVE CHILDREN -->
        {% for child in goal.children|sort(attribute='due_date') %}
            {{ render_goal(child, depth + 1) }}
        {% endfor %}
    </div>
{% endmacro %}

<!-- MAIN RENDER LOOP -->
<div class="goals-container">
    {% for goal in goals if not goal.parent %}
        {{ render_goal(goal) }}
    {% else %}
        <p class="text-center text-muted mt-5">
            No goals yet. Create your first annual goal to begin!
        </p>
    {% endfor %}
</div>

<!-- Add Root Goal Button -->
<div class="text-center mt-4">
    <button class="btn btn-lg btn-dark add-root-goal">
        + Create Annual Goal
    </button>
</div>