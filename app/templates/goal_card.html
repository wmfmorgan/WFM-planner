<!-- app/templates/goal_card.html -->
<div class="col-md-6 mb-4">
    <div class="card border-dark shadow-sm h-100" data-goal-id="{{ goal.id }}">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <span class="goal-title">{{ goal.title }}</span>
                <small class="badge bg-dark ms-2">{{ goal.type }}</small>
            </h5>
            <div>
                <button class="btn btn-sm btn-outline-dark edit-goal">Edit</button>
                <button class="btn btn-sm btn-outline-danger delete-goal">Delete</button>
            </div>
        </div>
        <div class="card-body">
            <p><strong>Description:</strong> {{ goal.description }}</p>
            {% if goal.motivation %}
                <p><strong>Motivation:</strong> <em>{{ goal.motivation }}</em></p>
            {% endif %}

        <!-- Overall Progress â€” BULLETPROOF -->
        <div class="progress mb-3" style="height: 25px;">
            <div class="progress-bar bg-dark text-white fw-bold no-svg-inject"
                role="progressbar"
                style="width: {{ goal.progress() }}%"
                aria-valuenow="{{ goal.progress() }}"
                aria-valuemin="0" aria-valuemax="100">
                {{ goal.progress() }}%
            </div>
        </div>

            <!-- FULL NESTED CARD HIERARCHY -->
            <div class="steps-container">
                {% if goal.nested_steps() %}
                    {% for q_date, months in goal.nested_steps().items() %}
                        <div class="mb-4">
                            <h6 class="fw-bold text-dark mb-3 border-bottom pb-2">
                                Q{{ ((q_date.month-1)//3)+1 }}: {{ q_date.strftime('%B %Y') }}
                            </h6>
                            {% for m_date, weeks in months.items() %}
                                <div class="mb-3 ms-3">
                                    <h6 class="fw-semibold text-secondary mb-2">
                                        MONTH: {{ m_date.strftime('%B') }}
                                    </h6>
                                    {% for w_date, day_steps in weeks.items() %}
                                        <div class="mb-2 ms-3">
                                            <h6 class="fw-medium text-muted small mb-2">
                                                WEEK: {{ w_date.strftime('%b %d') }} (Mon)
                                            </h6>
                                            <!-- DAY STEPS (SORTED BY DATE) -->
                                            {% set sorted_days = day_steps|list %}
                                            {% for step in sorted_days|sort(attribute='due_date') %}
                                                {% if step.step_type == 'day' %}
                                                    <div class="mb-2">
                                                        <div class="card border-dark step-card" data-step-id="{{ step.id }}">
                                                            <div class="card-body p-3 d-flex justify-content-between align-items-start">
                                                                <div class="form-check flex-grow-1">
                                                                    <input class="form-check-input step-checkbox" type="checkbox" {% if step.completed %}checked{% endif %}>
                                                                    <label class="form-check-label {% if step.completed %}text-decoration-line-through text-muted{% endif %}">
                                                                        <strong>DAY:</strong> {{ step.title }}
                                                                        <small class="text-muted d-block">
                                                                            {{ step.due_date.strftime('%b %d') }}
                                                                        </small>
                                                                    </label>
                                                                </div>
                                                                <div class="ms-3">
                                                                    <button class="btn btn-sm btn-outline-dark edit-step">Edit</button>
                                                                    <button class="btn btn-sm btn-outline-danger delete-step">Delete</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}

                                            <!-- NON-DAY STEPS (Q/M/W) IN THIS WEEK -->
                                            {% for step in day_steps %}
                                                {% if step.step_type in ['quarter', 'month', 'week'] %}
                                                    <div class="mb-2">
                                                        <div class="card border-dark step-card" data-step-id="{{ step.id }}">
                                                            <div class="card-body p-3 d-flex justify-content-between align-items-start">
                                                                <div class="form-check flex-grow-1">
                                                                    <input class="form-check-input step-checkbox" type="checkbox" {% if step.completed %}checked{% endif %}>
                                                                    <label class="form-check-label {% if step.completed %}text-decoration-line-through text-muted{% endif %}">
                                                                        <strong>{{ step.step_type|upper }}:</strong> {{ step.title }}
                                                                        {% if step.due_date %}
                                                                            <small class="text-muted d-block">
                                                                                {{ step.due_date.strftime('%b %d') }}{% if step.step_type == 'week' %} (Mon){% endif %}
                                                                            </small>
                                                                        {% endif %}
                                                                    </label>
                                                                </div>
                                                                <div class="ms-3">
                                                                    <button class="btn btn-sm btn-outline-dark edit-step">Edit</button>
                                                                    <button class="btn btn-sm btn-outline-danger delete-step">Delete</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Add dated steps to see the hierarchy!</p>
                {% endif %}
            </div>

            <!-- Add Step -->
            <div class="input-group mt-4">
                <input type="text" class="form-control form-control-sm new-step" placeholder="New step...">
                <input type="date" class="form-control form-control-sm date-input" style="width: 130px;">
                <select class="form-select form-select-sm type-select" style="width: 110px;">
                    <option value="auto">Auto</option>
                    <option value="quarter">Quarter</option>
                    <option value="month">Month</option>
                    <option value="week">Week</option>
                    <option value="day">Day</option>
                </select>
                <button class="btn btn-sm btn-dark add-step">Add</button>
            </div>
        </div>
    </div>
</div>