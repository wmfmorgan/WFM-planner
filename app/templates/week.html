<!-- app/templates/week.html — FULL WITH CALENDAR IN CARD BODY -->
{% extends "base.html" %}

{% block content %}

<div class="container mt-4">
    <!-- NAVIGATION -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{{ prev_url }}" class="btn btn-outline-dark">Previous Week</a>
        <h1 class="display-5 fw-bold text-center">{{ title }}</h1>
        <a href="{{ next_url }}" class="btn btn-outline-dark">Next Week</a>
    </div>

    <!-- DAY NAVIGATION CARD — CALENDAR GRID IN BODY -->
    <div class="card border-light mb-5">
        <div class="card-header bg-light">
            <h5 class="mb-0">Day Navigation</h5>
        </div>
        <div class="card-body p-3">
            <!-- BREADCRUMBS — BOLD, BELOW HEADER -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb p-0 bg-transparent">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('main.year_page', year=year) }}" class="text-dark fw-bold text-decoration-none">
                            {{ year }}
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('main.quarter_page', year=year, q_num=((sample_month-1)//3)+1) }}" 
                        class="text-dark fw-bold text-decoration-none">
                            Q{{ ((sample_month-1)//3)+1 }}
                        </a>
                    </li>
                    <li class="breadcrumb-item fw-bold" aria-current="page">
                        <a href="{{ url_for('main.month_page', year=year, month=month) }}" class="text-dark fw-bold text-decoration-none">
                            {{ month_name }}
                        </a>
                    </li>
                </ol>
            </nav>

<!-- WEEKLY CALENDAR — SAME STYLE AS MONTHLY -->
<div class="card mt-4">
    <!-- <div class="card-header">
        <h5 class="mb-0">Week {{ week }} — {{ year }}</h5>
    </div> -->
    <div class="card-body p-0">
        <table class="table table-bordered calendar-table mb-0">
            <thead class="table-light">
                <tr>
                    <!--<th class="text-center bg-light" style="width: 60px; font-weight: bold;">Week</th>-->
                    {% for day in ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'] %}
                        <th class="text-center">{{ day }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <tr>
                    <!-- WEEK NUMBER -->
                    <!-- <td class="text-center align-middle bg-light">
                        <a href="{{ url_for('main.week_page', year=year, week=week) }}" class="text-dark text-decoration-none">
                            <strong>W{{ week }}</strong>
                        </a>
                    </td>
                -->
                    <!-- 7 DAYS OF WEEK -->
                    {% for day_date in week_days %}
                        <td class="calendar-day position-relative">
                            <div class="day-number fw-bold">
                                <a href="{{ url_for('main.day_page', year=day_date.year, month=day_date.month, day=day_date.day) }}" class="text-dark text-decoration-none">
                                    {{ day_date.day }}
                                </a>
                            </div>
                            <div class="events-list mt-1">
                                {% for event in events_on_date(day_date.year, day_date.month, day_date.day) %}
                                    <div class="event-badge bg-primary text-white p-1 mb-1 rounded small text-truncate">
                                        {{ event.title }}
                                        {% if event.start_time %}
                                            {{ event.start_time.strftime('%H:%M') }}-{{ event.end_time.strftime('%H:%M') }}
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="add-event-area text-center text-muted small mt-2" style="cursor: pointer; font-size: 0.8em;">
                                + Add Event
                            </div>
                        </td>
                    {% endfor %}
                </tr>
            </tbody>
        </table>
    </div>
</div>

    <!-- PREP FOR THE WEEK -->
    <div class="card border-light mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Prep for the Week</h5>
        </div>
        <div class="card-body">
                    <textarea name="prep" class="form-control autosave" 
                    data-scope="week" data-year="{{ year }}" data-week="{{ week }}" data-type="prep" 
                    rows="5" 
                    placeholder="At the end of this week, what will my world look like? How will I get there?"></textarea>
        </div>
    </div>

    <!-- WEEKLY GOAL CARDS — FULL WIDTH -->
<h5 class="mb-3">Weekly Goals</h5>
    {% set columns = [
        {'id': 'todo', 'label': 'To Do'},
        {'id': 'in_progress', 'label': 'In Progress'},
        {'id': 'blocked', 'label': 'Blocked'},
        {'id': 'done', 'label': 'Done'}
    ] %}

    {% with goals=weekly_goals_grouped, columns=columns %}
        {% include 'kanban_board.html' %}
    {% endwith %}

    <!-- NOTES -->
    <div class="card border-light mt-5">
        <div class="card-header bg-light">
            <h5 class="mb-0">Notes</h5>
        </div>
        <div class="card-body">
                    <textarea name="notes" class="form-control autosave" 
                    data-scope="week" data-year="{{ year }}" data-week="{{ week }}" data-type="notes" 
                    rows="4" 
                    placeholder="Jot down thoughts, ideas, blockers..."></textarea>
        </div>
    </div>

    <!-- REVIEW -->
    <div class="row mt-5">
        <div class="col-md-6">
            <div class="card border-success h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Wins, Successes, Accomplishments</h5>
                </div>
                <div class="card-body">
                    <textarea name="wins" class="form-control autosave" 
                    data-scope="week" data-year="{{ year }}" data-week="{{ week }}" data-type="wins"   
                    rows="4" 
                    placeholder="What went well?"></textarea>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-warning h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Areas to Improve</h5>
                </div>
                <div class="card-body">
                    <textarea name="improve" class="form-control autosave" 
                    data-scope="week" data-year="{{ year }}" data-week="{{ week }}" data-type="improve" 
                    rows="4" 
                    placeholder="What could be better?"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
    let selectedDate = null;

    // CLICK + ADD EVENT → OPEN MODAL
    document.querySelectorAll('.add-event-area').forEach(area => {
        area.addEventListener('click', (e) => {
            const cell = e.target.closest('.calendar-day');
            if (cell && cell.dataset.date) {
                selectedDate = cell.dataset.date;
                document.getElementById('eventDate').value = selectedDate;
                document.getElementById('startDate').value = selectedDate;
                document.getElementById('endDate').value = selectedDate;
                modal.show();
            }
        });
    });

    // RECURRING TOGGLE
    document.getElementById('recurring').addEventListener('change', (e) => {
        document.getElementById('recurrenceOptions').classList.toggle('d-none', !e.target.checked);
    });

    // ALL DAY → DISABLE TIMES
    document.getElementById('allDay').addEventListener('change', (e) => {
        const timeFields = document.querySelectorAll('#startTime, #endTime');
        timeFields.forEach(f => f.disabled = e.target.checked);
    });

    // SUBMIT FORM
    document.getElementById('eventForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const data = {
            title: document.getElementById('eventTitle').value,
            start_date: document.getElementById('startDate').value,
            end_date: document.getElementById('endDate').value,
            start_time: document.getElementById('allDay').checked ? null : document.getElementById('startTime').value,
            end_time: document.getElementById('allDay').checked ? null : document.getElementById('endTime').value,
            all_day: document.getElementById('allDay').checked,
            is_recurring: document.getElementById('recurring').checked,
            recurrence_rule: document.getElementById('recurring').checked ? document.getElementById('recurrenceRule').value : null
        };

        fetch('/api/event', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(() => {
            location.reload();
        });
    });
});
</script>

{% endblock %}