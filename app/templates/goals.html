{% extends "base.html" %}
{% block title %}Goals{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/goals.css') }}">
  <script type="module" src="{{ url_for('static', filename='js/goals.js') }}" defer></script>
{% endblock %}


{% block content %}
<div class="container-fluid px-5 pt-5">
  <div class="position-relative mb-4">
    <h1 class="display-5 fw-bold text-center">Goals
      <button class="btn btn-success position-absolute top-0 end-0 rounded-circle shadow-sm"
              data-bs-toggle="modal" data-bs-target="#goalModal"
              title="Add New Goal">
        <i class="bi bi-plus-lg"></i>
      </button>
    </h1>
  </div>

  {% if goals %}
    <div class="goal-hierarchy">
      {% macro render_goal(goal, level=0) %}
        <div class="goal-item" style="margin-left: {{ level * 30 }}px;" data-goal-id="{{ goal.id }}">
          <div class="card mb-2 goal-card" data-goal-id="{{ goal.id }}" data-goal-type="{{ goal.type }}">

            <!-- VIEW MODE -->
            <div class="view-mode p-3">
              <div class="d-flex align-items-center gap-2">
                {% if goal.children or goal.category or goal.due_date %}
                  <i class="bi bi-chevron-right toggle-chevron"
                     style="font-size:0.9rem;cursor:pointer;color:#6c757d;transition:transform .2s ease;"></i>
                {% else %}
                  <span style="display:inline-block;width:1.1rem;"></span>
                {% endif %}

                <div class="flex-grow-1">
                  <h6 class="card-title mb-0 goal-title-text">{{ goal.title | escape }}</h6>
                </div>

                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-icon-secondary edit-goal-btn" title="Edit"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-sm btn-icon-primary add-subgoal-btn" data-parent-id="{{ goal.id }}" title="Add Sub-Goal"><i class="bi bi-plus-circle"></i></button>
                  <button class="btn btn-sm btn-icon-danger delete-goal-btn" data-goal-id="{{ goal.id }}" title="Delete"><i class="bi bi-trash"></i></button>
                </div>
              </div>
            </div>

            <!-- EDIT MODE -->
            <div class="edit-mode d-none p-3">
              <form class="edit-goal-form">
                <input type="hidden" name="goal_id" value="{{ goal.id }}">
                <div class="mb-2">
                  <input type="text" class="form-control form-control-sm goal-title-input" value="{{ goal.title | escape }}" required>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <select class="form-select form-select-sm goal-type-input">
                      <option value="annual" {% if goal.type == 'annual' %}selected{% endif %}>Annual</option>
                      <option value="quarterly" {% if goal.type == 'quarterly' %}selected{% endif %}>Quarterly</option>
                      <option value="monthly" {% if goal.type == 'monthly' %}selected{% endif %}>Monthly</option>
                      <option value="weekly" {% if goal.type == 'weekly' %}selected{% endif %}>Weekly</option>
                      <option value="daily" {% if goal.type == 'daily' %}selected{% endif %}>Daily</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <select class="form-select form-select-sm goal-category-input">
                      {% for value, label in [('Work','Work'),('Marital','Marital'),('Family','Family'),('Physical','Physical'),('Mental','Mental'),('Hobby','Hobby'),('Social','Social'),('Financial','Financial')] %}
                        <option value="{{ value }}" {% if goal.category == value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="mb-2"><textarea class="form-control form-control-sm goal-description-input" rows="2">{{ goal.description | escape or '' }}</textarea></div>
                <div class="mb-2"><textarea class="form-control form-control-sm goal-motivation-input" rows="2">{{ goal.motivation | escape or '' }}</textarea></div>
                <div class="row">
                  <div class="col-md-6"><input type="date" class="form-control form-control-sm goal-due-date-input" value="{{ goal.due_date.strftime('%Y-%m-%d') if goal.due_date else '' }}"></div>
                  <div class="col-md-6">
                    <select class="form-select form-select-sm goal-status-input">
                      <option value="todo" {% if goal.status == 'todo' %}selected{% endif %}>To Do</option>
                      <option value="in_progress" {% if goal.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                      <option value="blocked" {% if goal.status == 'blocked' %}selected{% endif %}>Blocked</option>
                      <option value="done" {% if goal.status == 'done' %}selected{% endif %}>Done</option>
                    </select>
                  </div>
                </div>
                <div class="form-check mb-2">
                  <input type="checkbox" class="form-check-input goal-completed-input" {% if goal.completed %}checked{% endif %}>
                  <label class="form-check-label">Completed</label>
                </div>
                <div class="d-flex gap-1">
                  <button type="submit" class="btn btn-sm btn-success">Save</button>
                  <button type="button" class="btn btn-sm btn-secondary cancel-edit">Cancel</button>
                </div>
              </form>
            </div>
          </div>

          {% if goal.children or goal.category or goal.due_date %}
          <div class="goal-collapse" data-collapsed="true">
            <div class="px-3 py-2 text-muted small border-top">
              <div><strong>{{ goal.type|capitalize }}</strong></div>
              {% if goal.description %}<div>{{ goal.description }}</div>{% endif %}
              {% if goal.category %}<div>{{ goal.category }}</div>{% endif %}
              {% if goal.status %}<div>{{ get_goal_status_label(goal.status) }}</div>{% endif %}
              {% if goal.due_date %}<div>{{ goal.due_date.strftime('%b %d') }}</div>{% endif %}
            </div>
            {% if goal.children %}
              {% for child in goal.children %}
                {{ render_goal(child, level + 1) }}
              {% endfor %}
            {% endif %}
          </div>
          {% endif %}
        </div>
      {% endmacro %}

      {% for goal in goals %}
        {{ render_goal(goal) }}
      {% endfor %}
    </div>
  {% else %}
    <p class="text-center text-muted">No goals yet. Click the + to create one!</p>
  {% endif %}
</div>

<!-- UNIFIED GOAL MODAL -->
<div class="modal fade" id="goalModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Create Goal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="unified-goal-form">
          <input type="hidden" name="parent_id" value="">
          <input type="hidden" name="goal_id" value="">
          <input type="hidden" name="hidden_type" id="hidden-type-field">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">


          <div class="mb-3">
            <label class="form-label">Title</label>
            <input name="title" class="form-control" required>
          </div>
          <div class="row">
            <div class="col-md-6"><div class="mb-3">
              <label class="form-label">Type</label>
              <select name="type" class="form-select goal-type-select"></select>
            </div></div>
            <div class="col-md-6"><div class="mb-3">
              <label class="form-label">Category</label>
              <select name="category" class="form-select"></select>
            </div></div>
          </div>
          <div class="mb-3"><label class="form-label">Description</label><textarea name="description" class="form-control" rows="3"></textarea></div>
          <div class="mb-3"><label class="form-label">Motivation</label><textarea name="motivation" class="form-control" rows="3"></textarea></div>
          <div class="row">
            <div class="col-md-6"><div class="mb-3"><label class="form-label">Due Date</label><input type="date" name="due_date" class="form-control"></div></div>
            <div class="col-md-6"><div class="mb-3"><label class="form-label">Status</label><select name="status" class="form-select"></select></div></div>
          </div>
          <div class="form-check mb-3">
            <input type="checkbox" name="completed" class="form-check-input">
            <label class="form-check-label">Completed</label>
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Save Goal</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}