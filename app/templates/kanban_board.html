<!-- app/templates/kanban_board.html -->
<div class="kanban-board mt-4">
    <div class="row g-3">
        {% for col in columns %}
            <div class="col">
                <div class="card border-light">
                    <div class="card-header bg-light text-center d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 text-uppercase fw-bold">
                            {{ col.label }}
                            <span class="badge bg-primary ms-2">{{ goals[col.id]|length }}</span>
                        </h6>
                        {% if type == 'goals' %}
                            <button class="btn btn-sm btn-outline-success add-kanban-item-btn"
                                    data-parent-type="{{ parent_type }}" data-page-type="{{ page_type }}">
                                <i class="bi bi-plus"></i>
                            </button>
                        {% endif %}
                    </div>
                    <div class="card-body p-2 d-flex flex-column h-100">
                        <div class="kanban-column flex-grow-1" data-status="{{ col.id }}" data-type="{{ type }}">
                            {% for item in goals[col.id] %}
                                <div class="kanban-item card mb-2 d-flex align-items-center {% if type == 'goals' %}edit-goal-card{% endif %}"
                                    data-item-id="{{ item.id }}"
                                    data-full-title="{{ item.title|escape or item.description|escape }}">

                                    <!-- DRAG HANDLE (left side) -->
                                    <div class="drag-handle text-muted flex-shrink-0 d-flex align-items-center justify-content-center px-3">
                                        <i class="bi bi-grip-vertical fs-5"></i>
                                    </div>
                                    
                                    <!-- TITLE TEXT (right next to handle) -->
                                    <div class="flex-grow-1 text-truncate pe-3">
                                        <div class="task-text card-title mb-0 fw-medium">
                                            {{ item.title | default(item.description) | escape }}
                                        </div>

                                        {% if type == 'tasks' %}
                                            <input type="text"
                                                class="task-edit form-control form-control-sm d-none"
                                                value="{{ item.description | escape }}"
                                                style="height: 38px;">
                                        {% endif %}
                                    </div>

                                    <!-- DELETE BUTTON â€” TASKS ONLY -->
                                    {% if type == 'tasks' %}
                                    <button type="button"
                                            class="btn btn-icon-danger btn-sm m-1 opacity-0"
                                            title="Delete task">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            {% endfor %}

                            {% if type == 'tasks' and col.id == 'todo' %}
                                <form id="add-task-form" class="mt-2">
                                    <input type="text" class="form-control add-task-input border-0 shadow-sm"
                                        placeholder="+ Add a task..." autocomplete="off" required />
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- UNIFIED GOAL MODAL FOR KANBAN -->
<div class="modal fade" id="goalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Create Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="kanban_unified-goal-form">
                    {{ form.hidden_tag() }}
                    <!-- <input type="hidden" name="parent_id" value=""> -->
                    <!-- IN MODAL, AFTER parent_id -->
                    <input type="hidden" name="goal_id" value="">
                    <input type="hidden" name="type" id="kanban-hidden-type">

                    <div class="mb-3">
                        {{ form.title.label(class="form-label") }}
                        {{ form.title(class="form-control") }}
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.type.label(class="form-label") }}
                                {{ form.type(class="form-select goal-type-select") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.category.label(class="form-label") }}
                                {{ form.category(class="form-select") }}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", rows=3) }}
                    </div>

                    <div class="mb-3">
                        {{ form.motivation.label(class="form-label") }}
                        {{ form.motivation(class="form-control", rows=3) }}
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.due_date.label(class="form-label") }}
                                {{ form.due_date(class="form-control") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.status.label(class="form-label") }}
                                {{ form.status(class="form-select") }}
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        {{ form.completed(class="form-check-input") }}
                        {{ form.completed.label(class="form-check-label") }}
                    </div>

                    <!-- IN KANBAN MODAL, AFTER TYPE -->
                    <div class="mb-3" id="kanban-parent-section">
                        <label class="form-label">Link to Parent Goal</label>
                        <select class="form-select" name="parent_id">
                            <option value="">-- None (Top-Level) --</option>
                            {% for parent in possible_parents %}
                                <option value="{{ parent.id }}">{{ parent.title }} {{parent.due_date}} ({{ parent.type|capitalize }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="d-flex gap-2">
                        {{ form.submit(class="btn btn-primary") }}
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
 
                </form>
            </div>
        </div>
    </div>
</div>

